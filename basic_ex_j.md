# 基礎演習課題(行列積)について

## 課題

以下を満たすプログラムを作成しなさい。

* バイナリファイルで与えられた行列A, Bの積Cを計算する。
* 行列Cを指定されたフォーマットでファイルに出力する。
* 作成するプログラム(multiply_matrix)は以下の使い方で実行できるものとする。

逐次版
```
$ multiply_matrix <A行列ファイル名> <B行列ファイル名> <C行列ファイル名> 
```

並列版
```
$ mpirun [オプション] multiply_matrix_mpi <A行列ファイル名> <B行列ファイル名> <C行列ファイル名> 
```


## 行列ファイルの仕様

* 先頭から32bit符号付き整数(int)で行数、列数が順に格納される
* 倍精度浮動小数点型(double)で(0, 0), (1, 0), (2, 0), … (N-1, 0), (0, 1), (1, 1), …, (N-1, N-1)の順に値が格納される


## ヒント

C言語でのサンプルコードを用意しました()。


適宜参考にしてください。
* 必ず使わなければいけないわけではありません
* バグをわざと入れています。

### tarball(.tar.gzファイル)の展開方法

-  matrix_multiplication_sample.tar.gzをダウンロードし、任意のディレクトリに保存します。

-  tarコマンドで展開します。

```
tar zxvf matrix_multiplication_sample.tar.gz 
```

-  エラーが無ければ、ディレクトリmatrix_multiplication_sampleが作成され、中にファイルが作られます。


### コンパイル・ビルドの方法

-  カレントディレクトリを先ほど展開したディレクトリに移動します。

```
cd matrix_multiplication_sample
```

-  Makefileが用意されているので、makeを実行します。  

```
make
```
エラーが無ければ、実行ファイル(make_matrix, show_matrixなど)が作成されます。  
make_matrixで大きな行列を作成するときは、ファイルサイズに注意してください。

-  macならテスト用に行列積(mul_matrix)および逆行列計算(inv_matrix)プログラムが作成できます。

```
make extra
```

検算などに利用してください。


### サンプルコードの解説

* 注意事項
    * 本サンプルコードは意図的に仕様を満たしていません。
プログラミングに慣れていない人は一行一行解読していってください。
    * 内容を素直に理解してもらうために、エラー処理は完全には行われていません。  
堅牢なプログラムを作るように努力してください。
    * 漢字コード
漢字コードはUTF-8で書かれています。  
コメント等が文字化けしている場合は漢字コードを適切に設定してください。

* matrix.c, matrix.h  
行列を取り扱う上で、繰り返し利用されそうな関数を記述しています。  
利用する際は、ヘッダファイル(matrix.h)をインクルードします。

  * Matrix構造体(struct Matrix)
行列を扱う構造体です。
行数、列数、内部データを格納しています。

  * create_matrix()関数  
行列を作成します。引数に作成する行列の行数と列数を指定します。  
したがって、動的にサイズを規定して行列を作成します(ソースコード上に行列サイズを決め打ちしません)。  
動的なメモリ管理の方法をこの関数で学んでください。  
動的に行列格納用のメモリを確保した都合上、  
作成された行列はdestroy_matrix()関数で後片付けをしなければなりません。

  * destroy_matrix()関数  
行列を廃棄します。一度廃棄した行列は二度と使用できません。

  * load_matrix()関数, save_matrix()関数  
ディスク上の行列を読み込み(load_matrix)、またディスクへ行列を書き込み(save_matrix)ます。  
バイナリデータの読み書き(I/O)の方法を参考にしてください。

  * set_matrix()関数, get_matrix()関数  
行列要素にアクセスします。  
本サンプルコードでは一次元配列に行列要素を格納しています。  
行と列が指定された場合、一次元配列上の格納場所(インデックス)を計算し、読み(get)書き(set)します。

  * print_matrix()関数  
行列を標準出力に整形して出力します。  
デバッグ等に利用できます。

### サンプルコードの改善方法

メインのプログラムは、matrix_make.cを参考にして作成してください。  
ただし、プログラムの利用者が、正しくそのプログラムを使えるようにコーディングを工夫すること。  
具体的には、以下の観点も考えてコーディングしてください(必ずしも満足しなければならない要件ではありません)。  

* ソースを見たときに簡単にプログラムの仕様が理解できること(位置パラメタのそれぞれの意味等）
* 指定を間違えたときに、適切なメッセージを出力して、間違えかどうかわかるようにすること
* そのプログラムを、シェルから呼び出すときの配慮すること（プログラムの戻り値は正常/異常で分けること）
* 通常ではありえないような入力をしてもプログラムエラーにならないこと（領域破壊を起こすようなコーディングは無いか）


### プロファイルの取り方

詳しくは[利用支援ポータル](https://wisteria-www.cc.u-tokyo.ac.jp/)からマニュアルを参照のこと。  


### 基礎演習で作成すべき設計文書

* システム構成図は全員共通なので省略
* 並列化方針は、課題のポイント。処理の様子をシーケンス図と、各段階でのメモリの内容の模式図で書こう。
* 登場するクラスが少ないのでデータモデル図は省略でもよい。
    * Matrixしか登場しない、などとなる。

## 提出先、提出期限

* 提出方法
    * 講師のメールアカウント( @g.ecc.u-tokyo.ac.jp )に提出物を添付して送付すること。
    * メールの主題(Subject)に「演習結果提出」を入れてください。


* 提出物
    1. ソースコード一式（.c or .cpp, .h, Makefile)をzipで固めたもの
    2. スケーラビリティのテスト結果(Excelファイル)

    3. 処理の様子をしめすシーケンス図
    4. 各段階でのメモリの内容の模式図

* 提出期限
    * 5月14日(火) 19:00 JST 必着

* その他
    * 不明点があった場合、Slackやメールで質問可です。
    * メールの場合、上記のメールアカウントに主題「演習質問」と入れて送付してください。
